<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– AI å­¸ç¿’åœ°åœ–ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #54ACBF 0%, #011C40 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(1, 28, 64, 0.3);
        }

        h1 {
            color: #023859;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .subtitle {
            text-align: center;
            color: #26658C;
            margin-bottom: 30px;
            line-height: 1.6;
            font-weight: bold;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(167, 235, 242, 0.1);
            border-radius: 12px;
            border-left: 4px solid #54ACBF;
        }

        .section h2 {
            color: #023859;
            margin-bottom: 15px;
            font-size: 1.4em;
            font-weight: bold;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 15px 30px;
            background: #54ACBF;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        button:hover {
            background: #26658C;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(38, 101, 140, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .intro-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            line-height: 1.8;
            color: #333;
            margin-top: 15px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .radio-item {
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radio-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-item label {
            cursor: pointer;
            flex: 1;
            font-size: 15px;
        }

        .detail-box {
            background: white;
            padding: 25px;
            border-radius: 10px;
            line-height: 1.8;
            color: #333;
            margin-top: 15px;
        }

        .detail-box h3 {
            color: #667eea;
            margin: 20px 0 10px 0;
        }

        .detail-box p {
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 20px;
            font-size: 18px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .concept-tag {
            background: #54ACBF;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        hr {
            margin: 30px 0;
            border: none;
            border-top: 2px solid rgba(167, 235, 242, 0.5);
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 30px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI å­¸ç¿’åœ°åœ–ç”Ÿæˆå™¨</h1>
        <p class="subtitle">è¼¸å…¥ä¸»é¡Œ â†’ é¸æ“‡æƒ³å­¸ç¿’çš„ç¯€é» â†’ æŸ¥çœ‹è©³ç´°å…§å®¹ â†’ é¸æ“‡æƒ³æ·±å…¥çš„æ¦‚å¿µ</p>

        <!-- æ­¥é©Ÿ 0: è¼¸å…¥ä¸»é¡Œ -->
        <div class="section">
            <h2>å­¸ç¿’ä¸»é¡Œ</h2>
            <div class="input-group">
                <input type="text" id="topicInput" placeholder="ä¾‹å¦‚ï¼šRã€Pythonã€è³‡æ–™åˆ†æã€æ©Ÿå™¨å­¸ç¿’">
                <button id="btnGenerate" onclick="generateMap()">ç”Ÿæˆå­¸ç¿’åœ°åœ–</button>
            </div>
            <div id="introBox" class="hidden">
                <h3>ä¸»é¡Œä»‹ç´¹</h3>
                <div id="introContent" class="intro-box"></div>
            </div>
            
            <!-- AI å“è³ªæª¢æŸ¥å€ -->
            <div id="qualityCheckBox" style="margin-top: 20px; display: none;">
                <div style="background: rgba(167, 235, 242, 0.2); padding: 20px; border-radius: 10px; border-left: 4px solid #54ACBF; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <h3 style="color: #023859; margin-bottom: 15px; font-size: 18px; font-weight: bold;">å¯¦ç”¨æ€§æª¢æŸ¥</h3>
                    <div id="qualityCheckContent" style="color: #26658C; line-height: 1.8; font-size: 15px;"></div>
                    <button id="btnAutoFix" onclick="autoFixMap()" style="margin-top: 15px; padding: 12px 24px; background: #26658C; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; display: none;">
                        é‡æ–°å„ªåŒ–å­¸ç¿’åœ°åœ–
                    </button>
                </div>
            </div>
        </div>

        <hr>

        <!-- æ­¥é©Ÿ 1: é¸æ“‡ç¯€é» -->
        <div class="section">
            <h2>æ­¥é©Ÿ 1ï¼šé¸æ“‡æƒ³å­¸ç¿’çš„ç¯€é»</h2>
            <div id="nodeRadioGroup" class="radio-group">
                <div class="empty-state">ç”Ÿæˆå­¸ç¿’åœ°åœ–å¾Œæœƒé¡¯ç¤ºç¯€é»åˆ—è¡¨</div>
            </div>
            <button id="btnQueryNode" onclick="queryNodeDetails()" disabled>æŸ¥çœ‹æ­¤ç¯€é»çš„è©³ç´°å…§å®¹</button>
        </div>

        <hr>

        <!-- æ­¥é©Ÿ 2: ç¯€é»è©³ç´°å…§å®¹ -->
        <div class="section">
            <h2>æ­¥é©Ÿ 2ï¼šå­¸ç¿’å…§å®¹è©³æƒ…</h2>
            <div id="detailBox" class="empty-state">é¸æ“‡ç¯€é»å¾Œé»æ“Šã€ŒæŸ¥çœ‹è©³ç´°å…§å®¹ã€</div>
        </div>

        <hr>

        <!-- æ­¥é©Ÿ 3: é¸æ“‡æ ¸å¿ƒæ¦‚å¿µ -->
        <div class="section">
            <h2>æ­¥é©Ÿ 3ï¼šæ·±å…¥å­¸ç¿’æ ¸å¿ƒæ¦‚å¿µ</h2>
            <div id="conceptRadioGroup" class="radio-group">
                <div class="empty-state">æŸ¥çœ‹ç¯€é»è©³ç´°å…§å®¹å¾Œæœƒé¡¯ç¤ºæ ¸å¿ƒæ¦‚å¿µ</div>
            </div>
            <button id="btnQueryConcept" onclick="queryConceptDetails()" disabled>æ·±å…¥å­¸ç¿’æ­¤æ¦‚å¿µ</button>
        </div>

        <hr>

        <!-- æ­¥é©Ÿ 4: æ¦‚å¿µè©³ç´°èªªæ˜ -->
        <div class="section">
            <h2>æ·±å…¥å­¸ç¿’å…§å®¹</h2>
            <div id="deepBox" class="empty-state">é¸æ“‡æ¦‚å¿µå¾Œé»æ“Šã€Œæ·±å…¥å­¸ç¿’ã€</div>
        </div>
    </div>

    <script>
        // ========== é…ç½® ==========
        // ğŸ‘‡ è«‹æ›¿æ›æˆä½ çš„ Cloudflare Worker URL
        const WORKER_URL = 'https://billowing-sun-7ead.111701002.workers.dev';
        
        // ========== å…¨åŸŸç‹€æ…‹ ==========
        let currentMapData = [];
        let currentNodeTitle = '';
        let currentNodeLevel = '';
        let currentNodeSummary = '';
        let currentTopic = ''; // å„²å­˜ç•¶å‰ä¸»é¡Œ
        let qualityCheckResult = null; // å„²å­˜å“è³ªæª¢æŸ¥çµæœ

        // ========== å·¥å…·å‡½æ•¸ï¼šå‘¼å« Cloudflare Worker ==========
        async function callAPI(systemPrompt, userPrompt, useModel = 'default') {
            try {
                console.log('ğŸš€ é–‹å§‹å‘¼å« API...');
                console.log('Worker URL:', WORKER_URL);
                console.log('ä½¿ç”¨æ¨¡å‹:', useModel);
                
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        system: systemPrompt,
                        prompt: userPrompt,
                        model: useModel // å‚³éæ¨¡å‹åƒæ•¸
                    })
                });

                console.log('ğŸ“¡ API å›æ‡‰ç‹€æ…‹:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API éŒ¯èª¤å›æ‡‰:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('âœ… API å›æ‡‰è³‡æ–™:', data);
                
                if (!data.content) {
                    throw new Error('API å›æ‡‰ä¸­æ²’æœ‰ content æ¬„ä½');
                }
                
                return data.content;
            } catch (error) {
                console.error('âŒ API å‘¼å«å¤±æ•—:', error);
                throw error; // æ‹‹å‡ºéŒ¯èª¤è®“ä¸Šå±¤è™•ç†
            }
        }

        // ========== é¡¯ç¤ºè¼‰å…¥å‹•ç•« ==========
        function showLoading(elementId) {
            const el = document.getElementById(elementId);
            el.innerHTML = '<div class="loading"><div class="spinner"></div>ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...</div>';
        }

        // ========== 1. ç”Ÿæˆå­¸ç¿’åœ°åœ– ==========
        async function generateMap() {
            const topic = document.getElementById('topicInput').value.trim();
            
            if (!topic) {
                alert('è«‹è¼¸å…¥å­¸ç¿’ä¸»é¡Œï¼');
                return;
            }
            
            // æª¢æŸ¥ Worker URL æ˜¯å¦å·²è¨­å®š
            if (WORKER_URL === 'YOUR_CLOUDFLARE_WORKER_URL') {
                document.getElementById('introContent').innerHTML = `
                    <p style="color: red;">âŒ éŒ¯èª¤ï¼šå°šæœªè¨­å®š Cloudflare Worker URL</p>
                    <p style="color: #666; font-size: 14px;">
                        è«‹åœ¨ç¨‹å¼ç¢¼ç¬¬ 227 è¡Œä¿®æ”¹ <code>WORKER_URL</code> è®Šæ•¸<br>
                        æ›¿æ›æˆä½ çš„ Worker URLï¼Œä¾‹å¦‚ï¼š<br>
                        <code>https://ai-learning-map-api.ä½ çš„å¸³è™Ÿ.workers.dev</code>
                    </p>
                `;
                document.getElementById('introBox').classList.remove('hidden');
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥
            showLoading('introContent');
            document.getElementById('introBox').classList.remove('hidden');
            document.getElementById('nodeRadioGroup').innerHTML = '<div class="loading"><div class="spinner"></div>ç”Ÿæˆä¸­...</div>';
            document.getElementById('detailBox').className = 'empty-state';
            document.getElementById('detailBox').textContent = '_è«‹å…ˆé¸æ“‡ç¯€é»_';
            document.getElementById('conceptRadioGroup').innerHTML = '<div class="empty-state">_è«‹å…ˆæŸ¥çœ‹ç¯€é»è©³ç´°å…§å®¹_</div>';
            document.getElementById('deepBox').className = 'empty-state';
            document.getElementById('deepBox').textContent = '_è«‹å…ˆé¸æ“‡æ¦‚å¿µ_';
            
            // ç¦ç”¨æŒ‰éˆ•
            document.getElementById('btnQueryNode').disabled = true;
            document.getElementById('btnQueryConcept').disabled = true;

            const systemPrompt = `ä½ æ˜¯ä¸€å€‹å­¸ç¿’è·¯ç·šè¦åŠƒ AIã€‚è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚
ä½ å¿…é ˆè¼¸å‡ºåˆæ³•çš„ JSON æ ¼å¼,åŒ…å«ä¸»é¡Œç°¡ä»‹å’Œå­¸ç¿’åœ°åœ–ç¯€é»ã€‚
å‹™å¿…ç¢ºä¿ JSON æ ¼å¼å®Œæ•´ä¸”æ­£ç¢ºã€‚`;

            const userPrompt = `è«‹é‡å°ä¸»é¡Œã€Œ${topic}ã€è¼¸å‡º JSONã€‚
æ ¼å¼å¦‚ä¸‹ï¼š
{
  "intro": "ä¸»é¡Œç°¡ä»‹ï¼ˆ100å­—å…§ï¼‰",
  "map": [
    {
      "title": "æŠ€èƒ½åç¨±",
      "level": "åˆéš",
      "summary": "ç°¡çŸ­æ‘˜è¦ï¼ˆ20å­—å…§ï¼‰"
    },
    {
      "title": "æŠ€èƒ½åç¨±",
      "level": "ä¸­éš",
      "summary": "ç°¡çŸ­æ‘˜è¦ï¼ˆ20å­—å…§ï¼‰"
    },
    {
      "title": "æŠ€èƒ½åç¨±",
      "level": "é€²éš",
      "summary": "ç°¡çŸ­æ‘˜è¦ï¼ˆ20å­—å…§ï¼‰"
    }
  ]
}

è«‹å‹™å¿…åŒ…å«åˆéšã€ä¸­éšã€é€²éšå„è‡³å°‘ 2-3 å€‹ç¯€é»,ä¸¦è¼¸å‡ºå®Œæ•´åˆæ³•çš„ JSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€‚`;

            try {
                console.log('ğŸ“ é–‹å§‹ç”Ÿæˆå­¸ç¿’åœ°åœ–...');
                const response = await callAPI(systemPrompt, userPrompt);
                console.log('ğŸ“¥ æ”¶åˆ° API å›æ‡‰ï¼ˆé•·åº¦ï¼‰:', response.length);
                console.log('ğŸ“¥ API å›æ‡‰å…§å®¹:', response);

                // æ¸…ç†å›æ‡‰å…§å®¹
                let cleanedResponse = response.trim();
                
                // ç§»é™¤å¯èƒ½çš„ Markdown æ¨™è¨˜
                cleanedResponse = cleanedResponse.replace(/```json/g, '').replace(/```/g, '');
                
                // æå– JSON
                const start = cleanedResponse.indexOf('{');
                const end = cleanedResponse.lastIndexOf('}') + 1;
                
                if (start === -1 || end === 0) {
                    throw new Error('æ‰¾ä¸åˆ° JSON æ ¼å¼çš„å…§å®¹ã€‚API å¯èƒ½å›å‚³äº†éŒ¯èª¤è¨Šæ¯ã€‚');
                }
                
                const jsonStr = cleanedResponse.substring(start, end);
                console.log('ğŸ” æå–çš„ JSON:', jsonStr);
                
                const data = JSON.parse(jsonStr);
                console.log('âœ… JSON è§£ææˆåŠŸ:', data);

                // é©—è­‰è³‡æ–™çµæ§‹
                if (!data.intro) {
                    throw new Error('JSON ä¸­ç¼ºå°‘ intro æ¬„ä½');
                }
                if (!data.map || !Array.isArray(data.map)) {
                    throw new Error('JSON ä¸­ç¼ºå°‘ map é™£åˆ—æˆ–æ ¼å¼ä¸æ­£ç¢º');
                }
                if (data.map.length === 0) {
                    throw new Error('å­¸ç¿’åœ°åœ–æ˜¯ç©ºçš„');
                }

                // é¡¯ç¤ºä»‹ç´¹
                document.getElementById('introContent').innerHTML = `<h3>ğŸ“˜ ${topic}</h3><p>${data.intro}</p>`;

                // é¡¯ç¤ºç¯€é»åˆ—è¡¨
                currentMapData = data.map;
                currentTopic = topic;
                renderNodeRadios(data.map);
                
                console.log('ğŸ‰ å­¸ç¿’åœ°åœ–ç”Ÿæˆå®Œæˆï¼');
                
                // è‡ªå‹•å•Ÿå‹•å“è³ªæª¢æŸ¥ï¼ˆå»¶é² 1 ç§’è®“ä½¿ç”¨è€…çœ‹åˆ°åœ°åœ–ï¼‰
                setTimeout(() => {
                    console.log('â° æº–å‚™å•Ÿå‹•å“è³ªæª¢æŸ¥...');
                    checkMapQuality(topic, data);
                }, 1000);

            } catch (error) {
                console.error('âŒ å®Œæ•´éŒ¯èª¤:', error);
                
                let errorHTML = `<p style="color: red;">âš ï¸ ç”Ÿæˆå¤±æ•—ï¼š${error.message}</p>`;
                
                // æ ¹æ“šéŒ¯èª¤é¡å‹æä¾›ä¸åŒçš„å»ºè­°
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorHTML += `
                        <p style="color: #666; font-size: 14px; margin-top: 10px;">
                            <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                            1. Worker URL è¨­å®šéŒ¯èª¤<br>
                            2. Worker å°šæœªéƒ¨ç½²æˆ–å·²åœç”¨<br>
                            3. ç¶²è·¯é€£ç·šå•é¡Œ<br><br>
                            <strong>è§£æ±ºæ–¹æ³•ï¼š</strong><br>
                            - ç¢ºèª Worker URL æ­£ç¢º<br>
                            - æª¢æŸ¥ Cloudflare Worker æ˜¯å¦æ­£å¸¸é‹ä½œ<br>
                            - é–‹å•Ÿç€è¦½å™¨ Console (F12) æŸ¥çœ‹è©³ç´°éŒ¯èª¤
                        </p>
                    `;
                } else if (error.message.includes('HTTP 401') || error.message.includes('HTTP 403')) {
                    errorHTML += `
                        <p style="color: #666; font-size: 14px; margin-top: 10px;">
                            <strong>å¯èƒ½åŸå› ï¼š</strong>API Key æœªè¨­å®šæˆ–ç„¡æ•ˆ<br><br>
                            <strong>è§£æ±ºæ–¹æ³•ï¼š</strong><br>
                            - åˆ° Cloudflare Worker è¨­å®šç’°å¢ƒè®Šæ•¸<br>
                            - ç¢ºèª GROQ_API_KEY æ­£ç¢ºç„¡èª¤
                        </p>
                    `;
                } else if (error.message.includes('Unexpected end of JSON')) {
                    errorHTML += `
                        <p style="color: #666; font-size: 14px; margin-top: 10px;">
                            <strong>å¯èƒ½åŸå› ï¼š</strong>API å›æ‡‰çš„ JSON ä¸å®Œæ•´<br><br>
                            <strong>è§£æ±ºæ–¹æ³•ï¼š</strong><br>
                            - æª¢æŸ¥ Worker ä¸­çš„ max_tokens è¨­å®š<br>
                            - ç¢ºèª API å›æ‡‰æ ¼å¼æ­£ç¢º<br>
                            - é–‹å•Ÿ Console (F12) æŸ¥çœ‹ API åŸå§‹å›æ‡‰
                        </p>
                    `;
                } else {
                    errorHTML += `
                        <p style="color: #666; font-size: 14px; margin-top: 10px;">
                            è«‹æŒ‰ F12 é–‹å•Ÿç€è¦½å™¨ Console æŸ¥çœ‹è©³ç´°éŒ¯èª¤è¨Šæ¯
                        </p>
                    `;
                }
                
                document.getElementById('introContent').innerHTML = errorHTML;
                document.getElementById('nodeRadioGroup').innerHTML = '<div class="empty-state">ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥éŒ¯èª¤è¨Šæ¯å¾Œé‡è©¦</div>';
            }
        }

        // ========== æ¸²æŸ“ç¯€é»å–®é¸æŒ‰éˆ• ==========
        function renderNodeRadios(nodes) {
            const container = document.getElementById('nodeRadioGroup');
            container.innerHTML = '';

            nodes.forEach((node, index) => {
                const div = document.createElement('div');
                div.className = 'radio-item';
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'nodeChoice';
                radio.id = `node${index}`;
                radio.value = index;
                radio.onchange = () => {
                    document.getElementById('btnQueryNode').disabled = false;
                };

                const label = document.createElement('label');
                label.htmlFor = `node${index}`;
                label.textContent = `ã€${node.level}ã€‘${node.title} - ${node.summary}`;

                div.appendChild(radio);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // ========== 2. æŸ¥è©¢ç¯€é»è©³ç´°å…§å®¹ ==========
        async function queryNodeDetails() {
            const selected = document.querySelector('input[name="nodeChoice"]:checked');
            
            if (!selected) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å­¸ç¿’ç¯€é»ï¼');
                return;
            }

            const index = parseInt(selected.value);
            const node = currentMapData[index];
            
            currentNodeTitle = node.title;
            currentNodeLevel = node.level;
            currentNodeSummary = node.summary;

            // é¡¯ç¤ºè¼‰å…¥
            showLoading('detailBox');
            document.getElementById('conceptRadioGroup').innerHTML = '<div class="loading"><div class="spinner"></div>ç”Ÿæˆä¸­...</div>';
            document.getElementById('deepBox').className = 'empty-state';
            document.getElementById('deepBox').textContent = '_è«‹å…ˆé¸æ“‡æ¦‚å¿µ_';

            const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å­¸ç¿’å°å¸«ã€‚è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚
æ ¹æ“šä½¿ç”¨è€…æä¾›çš„æŠ€èƒ½åç¨±å’Œå­¸ç¿’éšæ®µ,æä¾›è©³ç´°çš„å­¸ç¿’å»ºè­°ã€‚
åœ¨åˆ—å‡ºé—œéµæ¦‚å¿µæ™‚,è«‹ç”¨ã€ã€‘æ¨™è¨˜é‡è¦çš„å­æ¦‚å¿µ,ä¾‹å¦‚:ã€å‘é‡ã€‘ã€ã€è³‡æ–™æ¡†ã€‘ã€ã€å‡½æ•¸ã€‘ã€‚
æ¯å€‹ã€ã€‘å…§åªæ”¾ä¸€å€‹æ¦‚å¿µåç¨±,ä¸è¦æœ‰å¤šé¤˜çš„æ–‡å­—ã€‚`;

            const userPrompt = `æŠ€èƒ½åç¨±ï¼š${node.title}
å­¸ç¿’éšæ®µï¼š${node.level}
ç°¡ä»‹ï¼š${node.summary}

è«‹æä¾›ä»¥ä¸‹å…§å®¹ï¼Œä½¿ç”¨ç´”æ–‡å­—æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½• Markdown ç¬¦è™Ÿï¼ˆå¦‚ ** æˆ– *ï¼‰ï¼š

ğŸ“š æ ¸å¿ƒæ¦‚å¿µ
åˆ—å‡º 3-5 å€‹é—œéµæ¦‚å¿µ,æ¯å€‹æ¦‚å¿µç”¨ã€æ¦‚å¿µåç¨±ã€‘æ¨™è¨˜,ä¾‹å¦‚ï¼šã€å‘é‡ã€‘ã€ã€è³‡æ–™æ¡†ã€‘ã€ã€å‡½æ•¸ã€‘

ğŸ¯ å­¸ç¿’ç›®æ¨™
é€™å€‹éšæ®µæ‡‰è©²é”æˆä»€éº¼

ğŸ“– æ¨è–¦è³‡æº
æ›¸ç±ã€èª²ç¨‹ã€ç¶²ç«™ç­‰

ğŸ’¡ å¯¦ä½œå»ºè­°
å¦‚ä½•ç·´ç¿’

â±ï¸ é ä¼°æ™‚é–“
å¤§ç´„éœ€è¦å¤šä¹…

é‡è¦ï¼šå›è¦†è«‹ä½¿ç”¨ç´”æ–‡å­—ï¼Œä¸è¦ä½¿ç”¨ä»»ä½• Markdown æ ¼å¼ç¬¦è™Ÿï¼ˆ**ã€*ã€#ç­‰ï¼‰ï¼Œä¸¦ç¢ºä¿æ ¸å¿ƒæ¦‚å¿µéƒ¨åˆ†çš„æ¯å€‹é‡è¦æ¦‚å¿µéƒ½ç”¨ã€ã€‘æ¨™è¨˜ã€‚`;

            const response = await callAPI(systemPrompt, userPrompt);

            // é¡¯ç¤ºè©³ç´°å…§å®¹
            const formattedResponse = response.replace(/ã€([^ã€‘]+)ã€‘/g, '<span class="concept-tag">ã€$1ã€‘</span>');
            document.getElementById('detailBox').className = 'detail-box';
            document.getElementById('detailBox').innerHTML = `<h3>ğŸ“– ${node.title}ï¼ˆ${node.level}ï¼‰</h3>${formattedResponse.replace(/\n/g, '<br>')}`;

            // æå–æ¦‚å¿µ
            const concepts = extractConcepts(response);
            renderConceptRadios(concepts);
        }

        // ========== æå–ã€æ¦‚å¿µã€‘==========
        function extractConcepts(text) {
            const regex = /ã€([^ã€‘]+)ã€‘/g;
            const concepts = [];
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                if (!concepts.includes(match[1])) {
                    concepts.push(match[1]);
                }
            }
            
            return concepts;
        }

        // ========== æ¸²æŸ“æ¦‚å¿µå–®é¸æŒ‰éˆ• ==========
        function renderConceptRadios(concepts) {
            const container = document.getElementById('conceptRadioGroup');
            
            if (concepts.length === 0) {
                container.innerHTML = '<div class="empty-state">æœªæ‰¾åˆ°æ¨™è¨˜çš„æ ¸å¿ƒæ¦‚å¿µ</div>';
                document.getElementById('btnQueryConcept').disabled = true;
                return;
            }

            container.innerHTML = '';

            concepts.forEach((concept, index) => {
                const div = document.createElement('div');
                div.className = 'radio-item';
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'conceptChoice';
                radio.id = `concept${index}`;
                radio.value = concept;
                radio.onchange = () => {
                    document.getElementById('btnQueryConcept').disabled = false;
                };

                const label = document.createElement('label');
                label.htmlFor = `concept${index}`;
                label.textContent = concept;

                div.appendChild(radio);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // ========== 3. æŸ¥è©¢æ¦‚å¿µè©³ç´°å…§å®¹ ==========
        async function queryConceptDetails() {
            const selected = document.querySelector('input[name="conceptChoice"]:checked');
            
            if (!selected) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æ ¸å¿ƒæ¦‚å¿µï¼');
                return;
            }

            const concept = selected.value;

            // é¡¯ç¤ºè¼‰å…¥
            showLoading('deepBox');

            const systemPrompt = `ä½ æ˜¯ä¸€ä½è€å¿ƒçš„æ•™å­¸å°ˆå®¶ã€‚è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚
é‡å°å­¸ç¿’è€…æƒ³æ·±å…¥äº†è§£çš„ç‰¹å®šæ¦‚å¿µ,æä¾›è©³ç›¡çš„èªªæ˜ã€‚`;

            const userPrompt = `ä¸Šå±¤ä¸»é¡Œï¼š${currentNodeTitle}
å­æ¦‚å¿µï¼š${concept}

è«‹æä¾›ä»¥ä¸‹å…§å®¹ï¼Œä½¿ç”¨ç´”æ–‡å­—æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½• Markdown ç¬¦è™Ÿï¼ˆå¦‚ ** æˆ– *ï¼‰ï¼š

ğŸ” å®šç¾©
é€™å€‹æ¦‚å¿µæ˜¯ä»€éº¼

ğŸ’¡ ç‚ºä»€éº¼é‡è¦
åœ¨å­¸ç¿’ä¸­æ‰®æ¼”ä»€éº¼è§’è‰²

ğŸ“ å¯¦éš›ç¯„ä¾‹
ç”¨ç¨‹å¼ç¢¼æˆ–å¯¦ä¾‹èªªæ˜ï¼ˆå¦‚æœé©ç”¨çš„è©±ï¼‰

ğŸš€ é€²éšæ‡‰ç”¨
å¯ä»¥å¦‚ä½•å»¶ä¼¸

âš ï¸ å¸¸è¦‹éŒ¯èª¤
åˆå­¸è€…å®¹æ˜“çŠ¯çš„éŒ¯èª¤

é‡è¦ï¼šå›è¦†è«‹ä½¿ç”¨ç´”æ–‡å­—ï¼Œä¸è¦ä½¿ç”¨ä»»ä½• Markdown æ ¼å¼ç¬¦è™Ÿï¼ˆ**ã€*ã€#ç­‰ï¼‰ã€‚è«‹ç”¨æ·ºé¡¯æ˜“æ‡‚çš„æ–¹å¼èªªæ˜,ä¸¦æä¾›å…·é«”ç¯„ä¾‹ã€‚`;

            const response = await callAPI(systemPrompt, userPrompt);

            // é¡¯ç¤ºæ·±å…¥å…§å®¹
            document.getElementById('deepBox').className = 'detail-box';
            document.getElementById('deepBox').innerHTML = `<h3>ğŸ”¬ æ·±å…¥å­¸ç¿’ï¼š${concept}</h3>${response.replace(/\n/g, '<br>')}`;
        }

        // ========== Enter éµè§¸ç™¼ç”Ÿæˆ ==========
        document.getElementById('topicInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                generateMap();
            }
        });

        // ========== 4. AI å“è³ªæª¢æŸ¥æ©Ÿå™¨äºº ==========
        async function checkMapQuality(topic, data) {
            console.log('ğŸ¤– ===== å•Ÿå‹•å“è³ªæª¢æŸ¥æ©Ÿå™¨äºº =====');
            console.log('ğŸ“ ä¸»é¡Œ:', topic);
            console.log('ğŸ“Š ç¯€é»æ•¸é‡:', data.map.length);
            
            // é¡¯ç¤ºæª¢æŸ¥å€åŸŸ
            const checkBox = document.getElementById('qualityCheckBox');
            const checkContent = document.getElementById('qualityCheckContent');
            const fixBtn = document.getElementById('btnAutoFix');
            
            checkBox.style.display = 'block';
            checkContent.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div><br>â³ AI å“è³ªæª¢æŸ¥ä¸­ï¼Œè«‹ç¨å€™...</div>';
            fixBtn.style.display = 'none';
            
            console.log('âœ… å“è³ªæª¢æŸ¥å€åŸŸå·²é¡¯ç¤º');

            const systemPrompt = `ä½ æ˜¯ä¸€ä½åš´è¬¹çš„å­¸ç¿’è·¯å¾‘å“è³ªæª¢æŸ¥å°ˆå®¶ã€‚
ä½ çš„ä»»å‹™æ˜¯è©•ä¼°å­¸ç¿’åœ°åœ–çš„å“è³ªï¼Œçµ¦äºˆå®¢è§€è©•åˆ†ä¸¦æä¾›æ”¹é€²å»ºè­°ã€‚
ä½ å¿…é ˆåªè¼¸å‡º JSON æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€‚`;

            // çµ±è¨ˆå„éšæ®µç¯€é»æ•¸
            const levelCount = {
                'åˆéš': data.map.filter(n => n.level === 'åˆéš').length,
                'ä¸­éš': data.map.filter(n => n.level === 'ä¸­éš').length,
                'é€²éš': data.map.filter(n => n.level === 'é€²éš').length
            };
            
            console.log('ğŸ“ˆ éšæ®µåˆ†å¸ƒ:', levelCount);

            const userPrompt = `è«‹è©•ä¼°ä»¥ä¸‹å­¸ç¿’åœ°åœ–çš„å“è³ªï¼Œé‡é»æª¢æŸ¥å…§å®¹æ­£ç¢ºæ€§å’Œåˆç†æ€§ï¼š

ä¸»é¡Œï¼š${topic}
ç°¡ä»‹ï¼š${data.intro}

å­¸ç¿’ç¯€é»åˆ—è¡¨ï¼š
${data.map.map((node, i) => `${i+1}. ã€${node.level}ã€‘${node.title} - ${node.summary}`).join('\n')}

è©•ä¼°é‡é»ï¼ˆè«‹åš´æ ¼æª¢æŸ¥ï¼‰ï¼š
1. ç¯€é»å…§å®¹æ˜¯å¦ç¬¦åˆè©²ä¸»é¡Œï¼ˆæœ‰æ²’æœ‰ä¸ç›¸é—œæˆ–éŒ¯èª¤çš„å…§å®¹ï¼‰
2. ç¯€é»åˆ†é¡æ˜¯å¦æ­£ç¢ºï¼ˆåˆéš/ä¸­éš/é€²éšçš„é›£åº¦æ˜¯å¦åˆç†ï¼‰
3. å­¸ç¿’é †åºæ˜¯å¦ç¬¦åˆé‚è¼¯ï¼ˆåŸºç¤æ¦‚å¿µæ˜¯å¦åœ¨é€²éšæ¦‚å¿µä¹‹å‰ï¼‰
4. ç¯€é»æ¨™é¡Œå’Œæ‘˜è¦æ˜¯å¦æº–ç¢ºã€æ¸…æ™°
5. æ˜¯å¦æœ‰é‡è¦çš„æ ¸å¿ƒæ¦‚å¿µè¢«éºæ¼
6. æ˜¯å¦æœ‰æ˜é¡¯çš„éŒ¯èª¤æˆ–ä¸é©ç•¶çš„å…§å®¹

è«‹ä»¥ JSON æ ¼å¼å›æ‡‰ï¼ˆåªè¼¸å‡º JSONï¼‰ï¼š
{
  "hasIssues": false,
  "criticalIssues": [],
  "minorIssues": [],
  "suggestions": [],
  "needsFix": false
}

èªªæ˜ï¼š
- hasIssues: æ˜¯å¦ç™¼ç¾å•é¡Œï¼ˆtrue/falseï¼‰
- criticalIssues: åš´é‡å•é¡Œï¼ˆå¦‚å…§å®¹éŒ¯èª¤ã€åˆ†é¡ä¸ç•¶ã€é †åºæ··äº‚ï¼‰- é™£åˆ—
- minorIssues: æ¬¡è¦å•é¡Œï¼ˆå¦‚å¯ä»¥æ”¹é€²çš„åœ°æ–¹ï¼‰- é™£åˆ—
- suggestions: å…·é«”æ”¹é€²å»ºè­° - é™£åˆ—
- needsFix: æ˜¯å¦éœ€è¦ä¿®æ­£ï¼ˆåªæœ‰ criticalIssues ä¸ç‚ºç©ºæ™‚æ‰ç‚º trueï¼‰

é‡è¦ï¼š
- ä¸è¦å› ç‚ºç¯€é»æ•¸é‡å°‘å°±èªç‚ºæœ‰å•é¡Œï¼ˆ6-9å€‹ç¯€é»æ˜¯åˆç†çš„ï¼‰
- åªé—œæ³¨å…§å®¹çš„æ­£ç¢ºæ€§å’Œåˆç†æ€§
- å¦‚æœæ²’æœ‰æ˜é¡¯å•é¡Œï¼ŒcriticalIssues å’Œ minorIssues æ‡‰è©²æ˜¯ç©ºé™£åˆ—
- åªè¼¸å‡º JSONï¼Œä¸è¦å…¶ä»–å…§å®¹`;

            try {
                console.log('ğŸ“¤ ç™¼é€å“è³ªæª¢æŸ¥è«‹æ±‚...');
                
                // ä½¿ç”¨å¿«é€Ÿçš„ 8B æ¨¡å‹é€²è¡Œå“è³ªæª¢æŸ¥
                const response = await callAPI(systemPrompt, userPrompt, 'quality-check');
                
                console.log('ğŸ“¥ å“è³ªæª¢æŸ¥åŸå§‹å›æ‡‰:', response);
                
                // æ¸…ç†ä¸¦è§£æ JSON
                let cleaned = response.trim();
                cleaned = cleaned.replace(/```json/g, '').replace(/```/g, '');
                cleaned = cleaned.replace(/```/g, '');
                
                const start = cleaned.indexOf('{');
                const end = cleaned.lastIndexOf('}') + 1;
                
                if (start === -1 || end === 0) {
                    throw new Error('å›æ‡‰ä¸­æ‰¾ä¸åˆ° JSON æ ¼å¼');
                }
                
                const jsonStr = cleaned.substring(start, end);
                console.log('ğŸ” æå–çš„ JSON:', jsonStr);
                
                qualityCheckResult = JSON.parse(jsonStr);
                console.log('âœ… JSON è§£ææˆåŠŸ:', qualityCheckResult);
                
                // ç¢ºä¿è³‡æ–™æ ¼å¼æ­£ç¢º
                if (!Array.isArray(qualityCheckResult.difficultyIssues)) {
                    qualityCheckResult.difficultyIssues = [];
                }
                if (!Array.isArray(qualityCheckResult.orderIssues)) {
                    qualityCheckResult.orderIssues = [];
                }
                if (!Array.isArray(qualityCheckResult.contentIssues)) {
                    qualityCheckResult.contentIssues = [];
                }
                if (!Array.isArray(qualityCheckResult.suggestions)) {
                    qualityCheckResult.suggestions = [];
                }
                if (typeof qualityCheckResult.needsFix !== 'boolean') {
                    const totalIssues = qualityCheckResult.difficultyIssues.length + 
                                       qualityCheckResult.orderIssues.length + 
                                       qualityCheckResult.contentIssues.length;
                    qualityCheckResult.needsFix = totalIssues > 0;
                }
                
                console.log('ğŸ“Š å“è³ªæª¢æŸ¥çµæœ:', qualityCheckResult);
                
                // é¡¯ç¤ºæª¢æŸ¥çµæœ
                displayQualityCheck(qualityCheckResult);

            } catch (error) {
                console.error('âŒ å“è³ªæª¢æŸ¥å¤±æ•—:', error);
                console.error('éŒ¯èª¤å †ç–Š:', error.stack);
                checkContent.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px;">
                        <strong style="color: #721c24;">âš ï¸ å“è³ªæª¢æŸ¥å¤±æ•—</strong>
                        <p style="margin-top: 10px; color: #721c24;">éŒ¯èª¤ï¼š${error.message}</p>
                        <p style="margin-top: 5px; font-size: 12px; color: #721c24;">å­¸ç¿’åœ°åœ–å·²ç”Ÿæˆï¼Œä½ ä»å¯ç¹¼çºŒä½¿ç”¨</p>
                    </div>
                `;
            }
        }

        // ========== é¡¯ç¤ºå“è³ªæª¢æŸ¥çµæœ ==========
        function displayQualityCheck(result) {
            const checkContent = document.getElementById('qualityCheckContent');
            const fixBtn = document.getElementById('btnAutoFix');
            
            let html = '';
            const hasAnyIssues = (result.difficultyIssues && result.difficultyIssues.length > 0) ||
                                (result.orderIssues && result.orderIssues.length > 0) ||
                                (result.contentIssues && result.contentIssues.length > 0);
            
            let criticalIssuesCount = 0; // éœ€è¦ä¿®æ­£çš„å•é¡Œæ•¸é‡
            
            // é›£åº¦åˆ†é¡å•é¡Œ
            if (result.difficultyIssues && result.difficultyIssues.length > 0) {
                criticalIssuesCount += result.difficultyIssues.length;
                html += '<div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #ffc107; margin-bottom: 15px;">';
                html += '<strong style="font-size: 15px; color: #856404;">é›£åº¦åˆ†é¡å•é¡Œ</strong>';
                html += '<ul style="margin: 10px 0 0 20px; line-height: 1.8; color: #856404;">';
                result.difficultyIssues.forEach(issue => {
                    html += `<li style="margin: 5px 0;">${issue}</li>`;
                });
                html += '</ul></div>';
            }
            
            // é †åºå•é¡Œï¼ˆé€™é¡å•é¡Œéœ€è¦ä¿®æ­£ï¼‰
            if (result.orderIssues && result.orderIssues.length > 0) {
                criticalIssuesCount += result.orderIssues.length;
                html += '<div style="background: rgba(255, 152, 0, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #ff9800; margin-bottom: 15px;">';
                html += '<strong style="font-size: 15px; color: #e65100;">å­¸ç¿’é †åºå•é¡Œ</strong>';
                html += '<ul style="margin: 10px 0 0 20px; line-height: 1.8; color: #e65100;">';
                result.orderIssues.forEach(issue => {
                    html += `<li style="margin: 5px 0;">${issue}</li>`;
                });
                html += '</ul></div>';
            }
            
            // å…§å®¹å•é¡Œï¼ˆé€™é¡å•é¡Œéœ€è¦ä¿®æ­£ï¼‰
            if (result.contentIssues && result.contentIssues.length > 0) {
                criticalIssuesCount += result.contentIssues.length;
                html += '<div style="background: rgba(244, 67, 54, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #f44336; margin-bottom: 15px;">';
                html += '<strong style="font-size: 15px; color: #c62828;">å…§å®¹å®Œæ•´æ€§å•é¡Œ</strong>';
                html += '<ul style="margin: 10px 0 0 20px; line-height: 1.8; color: #c62828;">';
                result.contentIssues.forEach(issue => {
                    html += `<li style="margin: 5px 0;">${issue}</li>`;
                });
                html += '</ul></div>';
            }
            
            // æ”¹é€²å»ºè­°ï¼ˆé€™é¡å»ºè­°ä¸ä¸€å®šéœ€è¦ä¿®æ­£ï¼‰
            if (result.suggestions && result.suggestions.length > 0) {
                html += '<div style="background: rgba(84, 172, 191, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #54ACBF; margin-bottom: 15px;">';
                html += '<strong style="font-size: 15px; color: #023859;">æ”¹é€²å»ºè­°</strong>';
                html += '<ul style="margin: 10px 0 0 20px; line-height: 1.8; color: #26658C;">';
                result.suggestions.forEach(suggestion => {
                    html += `<li style="margin: 5px 0;">${suggestion}</li>`;
                });
                html += '</ul></div>';
            }
            
            // çµè«–å’ŒæŒ‰éˆ•
            if (criticalIssuesCount > 0) {
                // æœ‰éœ€è¦ä¿®æ­£çš„å•é¡Œï¼ˆé›£åº¦ã€é †åºã€å…§å®¹ï¼‰
                html += '<div style="padding: 15px; background: rgba(38, 101, 140, 0.1); border-radius: 8px; border: 2px solid #26658C;">';
                html += '<strong style="color: #023859; font-size: 15px;">ç™¼ç¾éœ€è¦ä¿®æ­£çš„å•é¡Œ</strong>';
                html += '<p style="margin-top: 8px; color: #26658C;">å»ºè­°ä¿®æ­£é€™äº›å•é¡Œä»¥ç¢ºä¿å­¸ç¿’æ•ˆæœ</p>';
                html += '</div>';
                fixBtn.style.display = 'block';
                fixBtn.textContent = 'ä¿®æ­£å•é¡Œä¸¦é‡æ–°ç”Ÿæˆ';
                console.log('é¡¯ç¤ºä¿®æ­£æŒ‰éˆ•ï¼ˆæœ‰é—œéµå•é¡Œï¼‰');
            } else if (result.suggestions && result.suggestions.length > 0) {
                // åªæœ‰å»ºè­°ï¼Œæ²’æœ‰é—œéµå•é¡Œ
                html += '<div style="padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border: 2px solid #4CAF50;">';
                html += '<strong style="color: #2e7d32; font-size: 15px;">å­¸ç¿’åœ°åœ–å“è³ªè‰¯å¥½</strong>';
                html += '<p style="margin-top: 8px; color: #388e3c;">æ²’æœ‰éœ€è¦ç«‹å³ä¿®æ­£çš„å•é¡Œã€‚ä¸Šè¿°å»ºè­°å¯ä»¥å¹«åŠ©é€²ä¸€æ­¥å®Œå–„ï¼Œä½†ä¸æ˜¯å¿…é ˆçš„ã€‚</p>';
                html += '</div>';
                fixBtn.style.display = 'none';
                console.log('éš±è—ä¿®æ­£æŒ‰éˆ•ï¼ˆåªæœ‰å»ºè­°ï¼‰');
            } else {
                // å®Œå…¨æ²’å•é¡Œ
                html += '<div style="padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border: 2px solid #4CAF50;">';
                html += '<strong style="color: #2e7d32; font-size: 15px;">å­¸ç¿’åœ°åœ–å“è³ªè‰¯å¥½</strong>';
                html += '<p style="margin-top: 8px; color: #388e3c;">æœªç™¼ç¾æ˜é¡¯å•é¡Œï¼Œå­¸ç¿’è€…å¯ä»¥æŒ‰ç…§é€™å€‹åœ°åœ–é †åˆ©å­¸ç¿’</p>';
                html += '</div>';
                fixBtn.style.display = 'none';
                console.log('éš±è—ä¿®æ­£æŒ‰éˆ•ï¼ˆå®Œç¾ï¼‰');
            }
            
            checkContent.innerHTML = html;
        }

        // ========== 5. è‡ªå‹•ä¿®æ­£å­¸ç¿’åœ°åœ– ==========
        async function autoFixMap() {
            if (!qualityCheckResult || !currentTopic) {
                alert('è«‹å…ˆç”Ÿæˆå­¸ç¿’åœ°åœ–ï¼');
                return;
            }

            console.log('ğŸ”§ é–‹å§‹è‡ªå‹•ä¿®æ­£...');
            
            // é¡¯ç¤ºä¿®æ­£ä¸­
            const checkContent = document.getElementById('qualityCheckContent');
            const fixBtn = document.getElementById('btnAutoFix');
            
            checkContent.innerHTML = 'â³ AI æ­£åœ¨ä¿®æ­£å­¸ç¿’åœ°åœ–ï¼Œè«‹ç¨å€™...<br><span style="font-size: 14px;">é€™å¯èƒ½éœ€è¦ 10-20 ç§’</span>';
            fixBtn.style.display = 'none';
            
            showLoading('introContent');
            document.getElementById('nodeRadioGroup').innerHTML = '<div class="loading"><div class="spinner"></div>é‡æ–°ç”Ÿæˆä¸­...</div>';

            const systemPrompt = `ä½ æ˜¯ä¸€å€‹å­¸ç¿’è·¯ç·šè¦åŠƒå°ˆå®¶ã€‚è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚
ä½ å¿…é ˆæ ¹æ“šå“è³ªæª¢æŸ¥çš„å»ºè­°ï¼Œé‡æ–°ç”Ÿæˆä¸€å€‹æ›´å¥½çš„å­¸ç¿’åœ°åœ–ã€‚
ä½ å¿…é ˆåªè¼¸å‡ºåˆæ³•çš„ JSON æ ¼å¼,ä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€‚`;

            const userPrompt = `è«‹é‡å°ä¸»é¡Œã€Œ${currentTopic}ã€é‡æ–°ç”Ÿæˆå­¸ç¿’åœ°åœ–ã€‚

å¯¦ç”¨æ€§æª¢æŸ¥ç™¼ç¾ä»¥ä¸‹å•é¡Œï¼š

é›£åº¦åˆ†é¡å•é¡Œï¼š
${qualityCheckResult.difficultyIssues && qualityCheckResult.difficultyIssues.length > 0 ? qualityCheckResult.difficultyIssues.join('\n') : 'ç„¡'}

å­¸ç¿’é †åºå•é¡Œï¼š
${qualityCheckResult.orderIssues && qualityCheckResult.orderIssues.length > 0 ? qualityCheckResult.orderIssues.join('\n') : 'ç„¡'}

å…§å®¹å®Œæ•´æ€§å•é¡Œï¼š
${qualityCheckResult.contentIssues && qualityCheckResult.contentIssues.length > 0 ? qualityCheckResult.contentIssues.join('\n') : 'ç„¡'}

æ”¹é€²å»ºè­°ï¼š
${qualityCheckResult.suggestions.join('\n')}

è«‹æ ¹æ“šé€™äº›å•é¡Œå’Œå»ºè­°ï¼Œé‡æ–°ç”Ÿæˆä¸€å€‹å„ªåŒ–å¾Œçš„å­¸ç¿’åœ°åœ–ã€‚

å„ªåŒ–é‡é»ï¼š
1. ç¢ºä¿é›£åº¦åˆ†é¡æ­£ç¢ºï¼ˆåˆéš=åˆå­¸è€…èƒ½ç†è§£ï¼Œé€²éš=éœ€è¦å…ˆå‚™çŸ¥è­˜ï¼‰
2. ç¢ºä¿å­¸ç¿’é †åºåˆç†ï¼ˆå…ˆå‚™çŸ¥è­˜åœ¨å‰ï¼Œæ‡‰ç”¨åœ¨å¾Œï¼‰
3. è£œå……éºæ¼çš„æ ¸å¿ƒæ¦‚å¿µ
4. ç§»é™¤éæ™‚æˆ–ä¸é‡è¦çš„å…§å®¹
5. ç¯€é»æ•¸é‡ä¿æŒåœ¨ 6-9 å€‹å³å¯

è«‹è¼¸å‡º JSON æ ¼å¼ï¼š
{
  "intro": "ä¸»é¡Œç°¡ä»‹ï¼ˆ100å­—å…§ï¼‰",
  "map": [
    {"title": "æŠ€èƒ½1", "level": "åˆéš", "summary": "æ‘˜è¦"},
    {"title": "æŠ€èƒ½2", "level": "åˆéš", "summary": "æ‘˜è¦"},
    {"title": "æŠ€èƒ½3", "level": "ä¸­éš", "summary": "æ‘˜è¦"},
    {"title": "æŠ€èƒ½4", "level": "ä¸­éš", "summary": "æ‘˜è¦"},
    {"title": "æŠ€èƒ½5", "level": "é€²éš", "summary": "æ‘˜è¦"},
    {"title": "æŠ€èƒ½6", "level": "é€²éš", "summary": "æ‘˜è¦"}
  ]
}

åªè¼¸å‡º JSONï¼Œä¸è¦æœ‰å…¶ä»–å…§å®¹ã€‚`;

            try {
                console.log('ğŸ“¤ ç™¼é€è‡ªå‹•ä¿®æ­£è«‹æ±‚...');
                
                // ä½¿ç”¨å¼·å¤§çš„ 70B æ¨¡å‹é€²è¡Œä¿®æ­£
                const response = await callAPI(systemPrompt, userPrompt, 'auto-fix');
                
                // æ¸…ç†ä¸¦è§£æ JSON
                let cleaned = response.trim();
                cleaned = cleaned.replace(/```json/g, '').replace(/```/g, '');
                const start = cleaned.indexOf('{');
                const end = cleaned.lastIndexOf('}') + 1;
                const jsonStr = cleaned.substring(start, end);
                
                const newData = JSON.parse(jsonStr);
                console.log('âœ… ä¿®æ­£å¾Œçš„å­¸ç¿’åœ°åœ–:', newData);

                // æ›´æ–°é¡¯ç¤º
                document.getElementById('introContent').innerHTML = `<h3>ğŸ“˜ ${currentTopic}</h3><p>${newData.intro}</p>`;
                currentMapData = newData.map;
                renderNodeRadios(newData.map);
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                const checkBox = document.getElementById('qualityCheckBox');
                checkContent.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 2px solid #28a745;">
                        <strong style="color: #155724; font-size: 16px;">âœ… å­¸ç¿’åœ°åœ–å·²è‡ªå‹•ä¿®æ­£å®Œæˆï¼</strong>
                        <p style="margin-top: 10px; color: #155724;">æ­£åœ¨é‡æ–°é€²è¡Œå“è³ªæª¢æŸ¥...</p>
                    </div>
                `;
                
                // é‡æ–°æª¢æŸ¥å“è³ª
                setTimeout(() => {
                    checkMapQuality(currentTopic, newData);
                }, 1000);
                
                console.log('ğŸ‰ å­¸ç¿’åœ°åœ–ä¿®æ­£å®Œæˆï¼');

            } catch (error) {
                console.error('âŒ è‡ªå‹•ä¿®æ­£å¤±æ•—:', error);
                checkContent.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 2px solid #dc3545;">
                        <strong style="color: #721c24;">âš ï¸ è‡ªå‹•ä¿®æ­£å¤±æ•—ï¼š${error.message}</strong>
                        <p style="margin-top: 10px; color: #721c24;">è«‹ä½¿ç”¨åŸå§‹å­¸ç¿’åœ°åœ–æˆ–é‡æ–°ç”Ÿæˆ</p>
                    </div>
                `;
                fixBtn.style.display = 'block';
                
                // æ¢å¾©åŸå§‹åœ°åœ–é¡¯ç¤º
                renderNodeRadios(currentMapData);
            }
        }
    </script>
</body>
</html>
