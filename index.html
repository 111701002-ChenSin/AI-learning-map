<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– AI å­¸ç¿’åœ°åœ–ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .intro-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            line-height: 1.8;
            color: #333;
            margin-top: 15px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .radio-item {
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radio-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-item label {
            cursor: pointer;
            flex: 1;
            font-size: 15px;
        }

        .detail-box {
            background: white;
            padding: 25px;
            border-radius: 10px;
            line-height: 1.8;
            color: #333;
            margin-top: 15px;
        }

        .detail-box h3 {
            color: #667eea;
            margin: 20px 0 10px 0;
        }

        .detail-box p {
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 20px;
            font-size: 18px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .concept-tag {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        hr {
            margin: 30px 0;
            border: none;
            border-top: 2px dashed #e0e0e0;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 30px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– AI å­¸ç¿’åœ°åœ–ç”Ÿæˆå™¨</h1>
        <p class="subtitle">ğŸ“– <strong>æµç¨‹ï¼š</strong>è¼¸å…¥ä¸»é¡Œ â†’ é¸æ“‡æƒ³å­¸ç¿’çš„ç¯€é» â†’ æŸ¥çœ‹è©³ç´°å…§å®¹ â†’ é¸æ“‡æƒ³æ·±å…¥çš„æ¦‚å¿µ</p>

        <!-- æ­¥é©Ÿ 0: è¼¸å…¥ä¸»é¡Œ -->
        <div class="section">
            <h2>ğŸ¯ å­¸ç¿’ä¸»é¡Œ</h2>
            <div class="input-group">
                <input type="text" id="topicInput" placeholder="ä¾‹å¦‚ï¼šRã€Pythonã€è³‡æ–™åˆ†æã€æ©Ÿå™¨å­¸ç¿’">
                <button id="btnGenerate" onclick="generateMap()">ğŸš€ ç”Ÿæˆå­¸ç¿’åœ°åœ–</button>
            </div>
            <div id="introBox" class="hidden">
                <h3>ğŸ“˜ ä¸»é¡Œä»‹ç´¹</h3>
                <div id="introContent" class="intro-box"></div>
            </div>
            
            <!-- AI å“è³ªæª¢æŸ¥å€ -->
            <div id="qualityCheckBox" style="margin-top: 20px; display: none;">
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="color: #856404; margin-bottom: 15px; font-size: 18px;">ğŸ¤– AI å“è³ªæª¢æŸ¥æ©Ÿå™¨äºº</h3>
                    <div id="qualityCheckContent" style="color: #856404; line-height: 1.8; font-size: 15px;"></div>
                    <button id="btnAutoFix" onclick="autoFixMap()" style="margin-top: 15px; padding: 12px 24px; background: #ff9800; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; display: none;">
                        ğŸ”§ è‡ªå‹•ä¿®æ­£å­¸ç¿’åœ°åœ–
                    </button>
                </div>
            </div>
        </div>

        <hr>

        <!-- æ­¥é©Ÿ 1: é¸æ“‡ç¯€é» -->
        <div class="section">
            <h2>ğŸ“‹ æ­¥é©Ÿ 1ï¼šé¸æ“‡æƒ³å­¸ç¿’çš„ç¯€é»</h2>
            <div id="nodeRadioGroup" class="radio-group">
                <div class="empty-state">_ç”Ÿæˆå­¸ç¿’åœ°åœ–å¾Œæœƒé¡¯ç¤ºç¯€é»åˆ—è¡¨_</div>
            </div>
            <button id="btnQueryNode" onclick="queryNodeDetails()" disabled>ğŸ“– æŸ¥çœ‹æ­¤ç¯€é»çš„è©³ç´°å…§å®¹</button>
        </div>

        <hr>

        <!-- æ­¥é©Ÿ 2: ç¯€é»è©³ç´°å…§å®¹ -->
        <div class="section">
            <h2>ğŸ“š æ­¥é©Ÿ 2ï¼šå­¸ç¿’å…§å®¹è©³æƒ…</h2>
            <div id="detailBox" class="empty-state">_é¸æ“‡ç¯€é»å¾Œé»æ“Šã€ŒæŸ¥çœ‹è©³ç´°å…§å®¹ã€_</div>
        </div>

        <hr>

        <!-- æ­¥é©Ÿ 3: é¸æ“‡æ ¸å¿ƒæ¦‚å¿µ -->
        <div class="section">
            <h2>ğŸ” æ­¥é©Ÿ 3ï¼šæ·±å…¥å­¸ç¿’æ ¸å¿ƒæ¦‚å¿µ</h2>
            <div id="conceptRadioGroup" class="radio-group">
                <div class="empty-state">_æŸ¥çœ‹ç¯€é»è©³ç´°å…§å®¹å¾Œæœƒé¡¯ç¤ºæ ¸å¿ƒæ¦‚å¿µ_</div>
            </div>
            <button id="btnQueryConcept" onclick="queryConceptDetails()" disabled>ğŸ”¬ æ·±å…¥å­¸ç¿’æ­¤æ¦‚å¿µ</button>
        </div>

        <hr>

        <!-- æ­¥é©Ÿ 4: æ¦‚å¿µè©³ç´°èªªæ˜ -->
        <div class="section">
            <h2>ğŸ’¡ æ·±å…¥å­¸ç¿’å…§å®¹</h2>
            <div id="deepBox" class="empty-state">_é¸æ“‡æ¦‚å¿µå¾Œé»æ“Šã€Œæ·±å…¥å­¸ç¿’ã€_</div>
        </div>
    </div>

    <script>
        // ========== é…ç½® ==========
        // ğŸ‘‡ è«‹æ›¿æ›æˆä½ çš„ Cloudflare Worker URL
        const WORKER_URL = 'https://billowing-sun-7ead.111701002.workers.dev';
        
        // ========== å…¨åŸŸç‹€æ…‹ ==========
        let currentMapData = [];
        let currentNodeTitle = '';
        let currentNodeLevel = '';
        let currentNodeSummary = '';
        let currentTopic = ''; // å„²å­˜ç•¶å‰ä¸»é¡Œ
        let qualityCheckResult = null; // å„²å­˜å“è³ªæª¢æŸ¥çµæœ

        // ========== å·¥å…·å‡½æ•¸ï¼šå‘¼å« Cloudflare Worker ==========
        async function callAPI(systemPrompt, userPrompt) {
            try {
                console.log('ğŸš€ é–‹å§‹å‘¼å« API...');
                console.log('Worker URL:', WORKER_URL);
                
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        system: systemPrompt,
                        prompt: userPrompt
                    })
                });

                console.log('ğŸ“¡ API å›æ‡‰ç‹€æ…‹:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API éŒ¯èª¤å›æ‡‰:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('âœ… API å›æ‡‰è³‡æ–™:', data);
                
                if (!data.content) {
                    throw new Error('API å›æ‡‰ä¸­æ²’æœ‰ content æ¬„ä½');
                }
                
                return data.content;
            } catch (error) {
                console.error('âŒ API å‘¼å«å¤±æ•—:', error);
                throw error; // æ‹‹å‡ºéŒ¯èª¤è®“ä¸Šå±¤è™•ç†
            }
        }

        // ========== é¡¯ç¤ºè¼‰å…¥å‹•ç•« ==========
        function showLoading(elementId) {
            const el = document.getElementById(elementId);
            el.innerHTML = '<div class="loading"><div class="spinner"></div>ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...</div>';
        }

        // ========== 1. ç”Ÿæˆå­¸ç¿’åœ°åœ– ==========
        async function generateMap() {
            const topic = document.getElementById('topicInput').value.trim();
            
            if (!topic) {
                alert('è«‹è¼¸å…¥å­¸ç¿’ä¸»é¡Œï¼');
                return;
            }
            
            // æª¢æŸ¥ Worker URL æ˜¯å¦å·²è¨­å®š
            if (WORKER_URL === 'YOUR_CLOUDFLARE_WORKER_URL') {
                document.getElementById('introContent').innerHTML = `
                    <p style="color: red;">âŒ éŒ¯èª¤ï¼šå°šæœªè¨­å®š Cloudflare Worker URL</p>
                    <p style="color: #666; font-size: 14px;">
                        è«‹åœ¨ç¨‹å¼ç¢¼ç¬¬ 227 è¡Œä¿®æ”¹ <code>WORKER_URL</code> è®Šæ•¸<br>
                        æ›¿æ›æˆä½ çš„ Worker URLï¼Œä¾‹å¦‚ï¼š<br>
                        <code>https://ai-learning-map-api.ä½ çš„å¸³è™Ÿ.workers.dev</code>
                    </p>
                `;
                document.getElementById('introBox').classList.remove('hidden');
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥
            showLoading('introContent');
            document.getElementById('introBox').classList.remove('hidden');
            document.getElementById('nodeRadioGroup').innerHTML = '<div class="loading"><div class="spinner"></div>ç”Ÿæˆä¸­...</div>';
            document.getElementById('detailBox').className = 'empty-state';
            document.getElementById('detailBox').textContent = '_è«‹å…ˆé¸æ“‡ç¯€é»_';
            document.getElementById('conceptRadioGroup').innerHTML = '<div class="empty-state">_è«‹å…ˆæŸ¥çœ‹ç¯€é»è©³ç´°å…§å®¹_</div>';
            document.getElementById('deepBox').className = 'empty-state';
            document.getElementById('deepBox').textContent = '_è«‹å…ˆé¸æ“‡æ¦‚å¿µ_';
            
            // ç¦ç”¨æŒ‰éˆ•
            document.getElementById('btnQueryNode').disabled = true;
            document.getElementById('btnQueryConcept').disabled = true;

            const systemPrompt = `ä½ æ˜¯ä¸€å€‹å­¸ç¿’è·¯ç·šè¦åŠƒ AIã€‚è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚
ä½ å¿…é ˆè¼¸å‡ºåˆæ³•çš„ JSON æ ¼å¼,åŒ…å«ä¸»é¡Œç°¡ä»‹å’Œå­¸ç¿’åœ°åœ–ç¯€é»ã€‚
å‹™å¿…ç¢ºä¿ JSON æ ¼å¼å®Œæ•´ä¸”æ­£ç¢ºã€‚`;

            const userPrompt = `è«‹é‡å°ä¸»é¡Œã€Œ${topic}ã€è¼¸å‡º JSONã€‚
æ ¼å¼å¦‚ä¸‹ï¼š
{
  "intro": "ä¸»é¡Œç°¡ä»‹ï¼ˆ100å­—å…§ï¼‰",
  "map": [
    {
      "title": "æŠ€èƒ½åç¨±",
      "level": "åˆéš",
      "summary": "ç°¡çŸ­æ‘˜è¦ï¼ˆ20å­—å…§ï¼‰"
    },
    {
      "title": "æŠ€èƒ½åç¨±",
      "level": "ä¸­éš",
      "summary": "ç°¡çŸ­æ‘˜è¦ï¼ˆ20å­—å…§ï¼‰"
    },
    {
      "title": "æŠ€èƒ½åç¨±",
      "level": "é€²éš",
      "summary": "ç°¡çŸ­æ‘˜è¦ï¼ˆ20å­—å…§ï¼‰"
    }
  ]
}

è«‹å‹™å¿…åŒ…å«åˆéšã€ä¸­éšã€é€²éšå„è‡³å°‘ 2-3 å€‹ç¯€é»,ä¸¦è¼¸å‡ºå®Œæ•´åˆæ³•çš„ JSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€‚`;

            try {
                console.log('ğŸ“ é–‹å§‹ç”Ÿæˆå­¸ç¿’åœ°åœ–...');
                const response = await callAPI(systemPrompt, userPrompt);
                console.log('ğŸ“¥ æ”¶åˆ° API å›æ‡‰ï¼ˆé•·åº¦ï¼‰:', response.length);
                console.log('ğŸ“¥ API å›æ‡‰å…§å®¹:', response);

                // æ¸…ç†å›æ‡‰å…§å®¹
                let cleanedResponse = response.trim();
                
                // ç§»é™¤å¯èƒ½çš„ Markdown æ¨™è¨˜
                cleanedResponse = cleanedResponse.replace(/```json/g, '').replace(/```/g, '');
                
                // æå– JSON
                const start = cleanedResponse.indexOf('{');
                const end = cleanedResponse.lastIndexOf('}') + 1;
                
                if (start === -1 || end === 0) {
                    throw new Error('æ‰¾ä¸åˆ° JSON æ ¼å¼çš„å…§å®¹ã€‚API å¯èƒ½å›å‚³äº†éŒ¯èª¤è¨Šæ¯ã€‚');
                }
                
                const jsonStr = cleanedResponse.substring(start, end);
                console.log('ğŸ” æå–çš„ JSON:', jsonStr);
                
                const data = JSON.parse(jsonStr);
                console.log('âœ… JSON è§£ææˆåŠŸ:', data);

                // é©—è­‰è³‡æ–™çµæ§‹
                if (!data.intro) {
                    throw new Error('JSON ä¸­ç¼ºå°‘ intro æ¬„ä½');
                }
                if (!data.map || !Array.isArray(data.map)) {
                    throw new Error('JSON ä¸­ç¼ºå°‘ map é™£åˆ—æˆ–æ ¼å¼ä¸æ­£ç¢º');
                }
                if (data.map.length === 0) {
                    throw new Error('å­¸ç¿’åœ°åœ–æ˜¯ç©ºçš„');
                }

                // é¡¯ç¤ºä»‹ç´¹
                document.getElementById('introContent').innerHTML = `<h3>ğŸ“˜ ${topic}</h3><p>${data.intro}</p>`;

                // é¡¯ç¤ºç¯€é»åˆ—è¡¨
                currentMapData = data.map;
                currentTopic = topic;
                renderNodeRadios(data.map);
                
                console.log('ğŸ‰ å­¸ç¿’åœ°åœ–ç”Ÿæˆå®Œæˆï¼');
                
                // è‡ªå‹•å•Ÿå‹•å“è³ªæª¢æŸ¥
                setTimeout(() => {
                    checkMapQuality(topic, data);
                }, 500);

            } catch (error) {
                console.error('âŒ å®Œæ•´éŒ¯èª¤:', error);
                
                let errorHTML = `<p style="color: red;">âš ï¸ ç”Ÿæˆå¤±æ•—ï¼š${error.message}</p>`;
                
                // æ ¹æ“šéŒ¯èª¤é¡å‹æä¾›ä¸åŒçš„å»ºè­°
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorHTML += `
                        <p style="color: #666; font-size: 14px; margin-top: 10px;">
                            <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                            1. Worker URL è¨­å®šéŒ¯èª¤<br>
                            2. Worker å°šæœªéƒ¨ç½²æˆ–å·²åœç”¨<br>
                            3. ç¶²è·¯é€£ç·šå•é¡Œ<br><br>
                            <strong>è§£æ±ºæ–¹æ³•ï¼š</strong><br>
                            - ç¢ºèª Worker URL æ­£ç¢º<br>
                            - æª¢æŸ¥ Cloudflare Worker æ˜¯å¦æ­£å¸¸é‹ä½œ<br>
                            - é–‹å•Ÿç€è¦½å™¨ Console (F12) æŸ¥çœ‹è©³ç´°éŒ¯èª¤
                        </p>
                    `;
                } else if (error.message.includes('HTTP 401') || error.message.includes('HTTP 403')) {
                    errorHTML += `
                        <p style="color: #666; font-size: 14px; margin-top: 10px;">
                            <strong>å¯èƒ½åŸå› ï¼š</strong>API Key æœªè¨­å®šæˆ–ç„¡æ•ˆ<br><br>
                            <strong>è§£æ±ºæ–¹æ³•ï¼š</strong><br>
                            - åˆ° Cloudflare Worker è¨­å®šç’°å¢ƒè®Šæ•¸<br>
                            - ç¢ºèª GROQ_API_KEY æ­£ç¢ºç„¡èª¤
                        </p>
                    `;
                } else if (error.message.includes('Unexpected end of JSON')) {
                    errorHTML += `
                        <p style="color: #666; font-size: 14px; margin-top: 10px;">
                            <strong>å¯èƒ½åŸå› ï¼š</strong>API å›æ‡‰çš„ JSON ä¸å®Œæ•´<br><br>
                            <strong>è§£æ±ºæ–¹æ³•ï¼š</strong><br>
                            - æª¢æŸ¥ Worker ä¸­çš„ max_tokens è¨­å®š<br>
                            - ç¢ºèª API å›æ‡‰æ ¼å¼æ­£ç¢º<br>
                            - é–‹å•Ÿ Console (F12) æŸ¥çœ‹ API åŸå§‹å›æ‡‰
                        </p>
                    `;
                } else {
                    errorHTML += `
                        <p style="color: #666; font-size: 14px; margin-top: 10px;">
                            è«‹æŒ‰ F12 é–‹å•Ÿç€è¦½å™¨ Console æŸ¥çœ‹è©³ç´°éŒ¯èª¤è¨Šæ¯
                        </p>
                    `;
                }
                
                document.getElementById('introContent').innerHTML = errorHTML;
                document.getElementById('nodeRadioGroup').innerHTML = '<div class="empty-state">ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥éŒ¯èª¤è¨Šæ¯å¾Œé‡è©¦</div>';
            }
        }

        // ========== æ¸²æŸ“ç¯€é»å–®é¸æŒ‰éˆ• ==========
        function renderNodeRadios(nodes) {
            const container = document.getElementById('nodeRadioGroup');
            container.innerHTML = '';

            nodes.forEach((node, index) => {
                const div = document.createElement('div');
                div.className = 'radio-item';
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'nodeChoice';
                radio.id = `node${index}`;
                radio.value = index;
                radio.onchange = () => {
                    document.getElementById('btnQueryNode').disabled = false;
                };

                const label = document.createElement('label');
                label.htmlFor = `node${index}`;
                label.textContent = `ã€${node.level}ã€‘${node.title} - ${node.summary}`;

                div.appendChild(radio);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // ========== 2. æŸ¥è©¢ç¯€é»è©³ç´°å…§å®¹ ==========
        async function queryNodeDetails() {
            const selected = document.querySelector('input[name="nodeChoice"]:checked');
            
            if (!selected) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å­¸ç¿’ç¯€é»ï¼');
                return;
            }

            const index = parseInt(selected.value);
            const node = currentMapData[index];
            
            currentNodeTitle = node.title;
            currentNodeLevel = node.level;
            currentNodeSummary = node.summary;

            // é¡¯ç¤ºè¼‰å…¥
            showLoading('detailBox');
            document.getElementById('conceptRadioGroup').innerHTML = '<div class="loading"><div class="spinner"></div>ç”Ÿæˆä¸­...</div>';
            document.getElementById('deepBox').className = 'empty-state';
            document.getElementById('deepBox').textContent = '_è«‹å…ˆé¸æ“‡æ¦‚å¿µ_';

            const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å­¸ç¿’å°å¸«ã€‚è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚
æ ¹æ“šä½¿ç”¨è€…æä¾›çš„æŠ€èƒ½åç¨±å’Œå­¸ç¿’éšæ®µ,æä¾›è©³ç´°çš„å­¸ç¿’å»ºè­°ã€‚
åœ¨åˆ—å‡ºé—œéµæ¦‚å¿µæ™‚,è«‹ç”¨ã€ã€‘æ¨™è¨˜é‡è¦çš„å­æ¦‚å¿µ,ä¾‹å¦‚:ã€å‘é‡ã€‘ã€ã€è³‡æ–™æ¡†ã€‘ã€ã€å‡½æ•¸ã€‘ã€‚
æ¯å€‹ã€ã€‘å…§åªæ”¾ä¸€å€‹æ¦‚å¿µåç¨±,ä¸è¦æœ‰å¤šé¤˜çš„æ–‡å­—ã€‚`;

            const userPrompt = `æŠ€èƒ½åç¨±ï¼š${node.title}
å­¸ç¿’éšæ®µï¼š${node.level}
ç°¡ä»‹ï¼š${node.summary}

è«‹æä¾›ä»¥ä¸‹å…§å®¹ï¼Œä½¿ç”¨ç´”æ–‡å­—æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½• Markdown ç¬¦è™Ÿï¼ˆå¦‚ ** æˆ– *ï¼‰ï¼š

ğŸ“š æ ¸å¿ƒæ¦‚å¿µ
åˆ—å‡º 3-5 å€‹é—œéµæ¦‚å¿µ,æ¯å€‹æ¦‚å¿µç”¨ã€æ¦‚å¿µåç¨±ã€‘æ¨™è¨˜,ä¾‹å¦‚ï¼šã€å‘é‡ã€‘ã€ã€è³‡æ–™æ¡†ã€‘ã€ã€å‡½æ•¸ã€‘

ğŸ¯ å­¸ç¿’ç›®æ¨™
é€™å€‹éšæ®µæ‡‰è©²é”æˆä»€éº¼

ğŸ“– æ¨è–¦è³‡æº
æ›¸ç±ã€èª²ç¨‹ã€ç¶²ç«™ç­‰

ğŸ’¡ å¯¦ä½œå»ºè­°
å¦‚ä½•ç·´ç¿’

â±ï¸ é ä¼°æ™‚é–“
å¤§ç´„éœ€è¦å¤šä¹…

é‡è¦ï¼šå›è¦†è«‹ä½¿ç”¨ç´”æ–‡å­—ï¼Œä¸è¦ä½¿ç”¨ä»»ä½• Markdown æ ¼å¼ç¬¦è™Ÿï¼ˆ**ã€*ã€#ç­‰ï¼‰ï¼Œä¸¦ç¢ºä¿æ ¸å¿ƒæ¦‚å¿µéƒ¨åˆ†çš„æ¯å€‹é‡è¦æ¦‚å¿µéƒ½ç”¨ã€ã€‘æ¨™è¨˜ã€‚`;

            const response = await callAPI(systemPrompt, userPrompt);

            // é¡¯ç¤ºè©³ç´°å…§å®¹
            const formattedResponse = response.replace(/ã€([^ã€‘]+)ã€‘/g, '<span class="concept-tag">ã€$1ã€‘</span>');
            document.getElementById('detailBox').className = 'detail-box';
            document.getElementById('detailBox').innerHTML = `<h3>ğŸ“– ${node.title}ï¼ˆ${node.level}ï¼‰</h3>${formattedResponse.replace(/\n/g, '<br>')}`;

            // æå–æ¦‚å¿µ
            const concepts = extractConcepts(response);
            renderConceptRadios(concepts);
        }

        // ========== æå–ã€æ¦‚å¿µã€‘==========
        function extractConcepts(text) {
            const regex = /ã€([^ã€‘]+)ã€‘/g;
            const concepts = [];
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                if (!concepts.includes(match[1])) {
                    concepts.push(match[1]);
                }
            }
            
            return concepts;
        }

        // ========== æ¸²æŸ“æ¦‚å¿µå–®é¸æŒ‰éˆ• ==========
        function renderConceptRadios(concepts) {
            const container = document.getElementById('conceptRadioGroup');
            
            if (concepts.length === 0) {
                container.innerHTML = '<div class="empty-state">æœªæ‰¾åˆ°æ¨™è¨˜çš„æ ¸å¿ƒæ¦‚å¿µ</div>';
                document.getElementById('btnQueryConcept').disabled = true;
                return;
            }

            container.innerHTML = '';

            concepts.forEach((concept, index) => {
                const div = document.createElement('div');
                div.className = 'radio-item';
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'conceptChoice';
                radio.id = `concept${index}`;
                radio.value = concept;
                radio.onchange = () => {
                    document.getElementById('btnQueryConcept').disabled = false;
                };

                const label = document.createElement('label');
                label.htmlFor = `concept${index}`;
                label.textContent = concept;

                div.appendChild(radio);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // ========== 3. æŸ¥è©¢æ¦‚å¿µè©³ç´°å…§å®¹ ==========
        async function queryConceptDetails() {
            const selected = document.querySelector('input[name="conceptChoice"]:checked');
            
            if (!selected) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æ ¸å¿ƒæ¦‚å¿µï¼');
                return;
            }

            const concept = selected.value;

            // é¡¯ç¤ºè¼‰å…¥
            showLoading('deepBox');

            const systemPrompt = `ä½ æ˜¯ä¸€ä½è€å¿ƒçš„æ•™å­¸å°ˆå®¶ã€‚è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚
é‡å°å­¸ç¿’è€…æƒ³æ·±å…¥äº†è§£çš„ç‰¹å®šæ¦‚å¿µ,æä¾›è©³ç›¡çš„èªªæ˜ã€‚`;

            const userPrompt = `ä¸Šå±¤ä¸»é¡Œï¼š${currentNodeTitle}
å­æ¦‚å¿µï¼š${concept}

è«‹æä¾›ä»¥ä¸‹å…§å®¹ï¼Œä½¿ç”¨ç´”æ–‡å­—æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½• Markdown ç¬¦è™Ÿï¼ˆå¦‚ ** æˆ– *ï¼‰ï¼š

ğŸ” å®šç¾©
é€™å€‹æ¦‚å¿µæ˜¯ä»€éº¼

ğŸ’¡ ç‚ºä»€éº¼é‡è¦
åœ¨å­¸ç¿’ä¸­æ‰®æ¼”ä»€éº¼è§’è‰²

ğŸ“ å¯¦éš›ç¯„ä¾‹
ç”¨ç¨‹å¼ç¢¼æˆ–å¯¦ä¾‹èªªæ˜ï¼ˆå¦‚æœé©ç”¨çš„è©±ï¼‰

ğŸš€ é€²éšæ‡‰ç”¨
å¯ä»¥å¦‚ä½•å»¶ä¼¸

âš ï¸ å¸¸è¦‹éŒ¯èª¤
åˆå­¸è€…å®¹æ˜“çŠ¯çš„éŒ¯èª¤

é‡è¦ï¼šå›è¦†è«‹ä½¿ç”¨ç´”æ–‡å­—ï¼Œä¸è¦ä½¿ç”¨ä»»ä½• Markdown æ ¼å¼ç¬¦è™Ÿï¼ˆ**ã€*ã€#ç­‰ï¼‰ã€‚è«‹ç”¨æ·ºé¡¯æ˜“æ‡‚çš„æ–¹å¼èªªæ˜,ä¸¦æä¾›å…·é«”ç¯„ä¾‹ã€‚`;

            const response = await callAPI(systemPrompt, userPrompt);

            // é¡¯ç¤ºæ·±å…¥å…§å®¹
            document.getElementById('deepBox').className = 'detail-box';
            document.getElementById('deepBox').innerHTML = `<h3>ğŸ”¬ æ·±å…¥å­¸ç¿’ï¼š${concept}</h3>${response.replace(/\n/g, '<br>')}`;
        }

        // ========== Enter éµè§¸ç™¼ç”Ÿæˆ ==========
        document.getElementById('topicInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                generateMap();
            }
        });

        // ========== 4. AI å“è³ªæª¢æŸ¥æ©Ÿå™¨äºº ==========
        async function checkMapQuality(topic, data) {
            console.log('ğŸ¤– å•Ÿå‹•å“è³ªæª¢æŸ¥æ©Ÿå™¨äºº...');
            
            // é¡¯ç¤ºæª¢æŸ¥å€åŸŸ
            const checkBox = document.getElementById('qualityCheckBox');
            const checkContent = document.getElementById('qualityCheckContent');
            const fixBtn = document.getElementById('btnAutoFix');
            
            checkBox.style.display = 'block';
            checkContent.innerHTML = 'â³ AI å“è³ªæª¢æŸ¥ä¸­ï¼Œè«‹ç¨å€™...';
            fixBtn.style.display = 'none';

            const systemPrompt = `ä½ æ˜¯ä¸€ä½åš´è¬¹çš„å­¸ç¿’è·¯å¾‘å“è³ªæª¢æŸ¥å°ˆå®¶ã€‚è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚
ä½ çš„ä»»å‹™æ˜¯è©•ä¼°å­¸ç¿’åœ°åœ–çš„å“è³ªï¼Œæ‰¾å‡ºå¯èƒ½çš„å•é¡Œã€‚
è«‹å‹™å¿…è¼¸å‡ºåˆæ³•çš„ JSON æ ¼å¼ã€‚`;

            const userPrompt = `è«‹è©•ä¼°ä»¥ä¸‹å­¸ç¿’åœ°åœ–çš„å“è³ªï¼š

ä¸»é¡Œï¼š${topic}
ç°¡ä»‹ï¼š${data.intro}

å­¸ç¿’ç¯€é»ï¼š
${data.map.map((node, i) => `${i+1}. ã€${node.level}ã€‘${node.title} - ${node.summary}`).join('\n')}

è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š
1. åˆéš/ä¸­éš/é€²éšçš„æ•¸é‡æ˜¯å¦å‡è¡¡ï¼ˆå„éšæ®µè‡³å°‘è¦æœ‰2å€‹ç¯€é»ï¼‰
2. ç¯€é»é †åºæ˜¯å¦åˆç†ï¼ˆæ˜¯å¦ç¬¦åˆå­¸ç¿’é †åºï¼‰
3. ç¯€é»å…§å®¹æ˜¯å¦æœ‰é‡è¤‡
4. ç¯€é»æ¨™é¡Œæ˜¯å¦æ¸…æ™°æ˜ç¢º
5. ç¯€é»æ‘˜è¦æ˜¯å¦ç°¡æ½”æœ‰ç”¨
6. æ•´é«”å­¸ç¿’è·¯å¾‘æ˜¯å¦å®Œæ•´ä¸”å¾ªåºæ¼¸é€²

è«‹ä»¥ JSON æ ¼å¼å›æ‡‰ï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ï¼š
{
  "score": 85,
  "hasIssues": true,
  "issues": [
    "åˆéšç¯€é»å¤ªå°‘ï¼Œå»ºè­°å¢åŠ åŸºç¤æ¦‚å¿µ",
    "ç¼ºå°‘å¯¦ä½œç·´ç¿’ç›¸é—œç¯€é»"
  ],
  "suggestions": [
    "åœ¨åˆéšå¢åŠ ï¼šåŸºæœ¬èªæ³•",
    "åœ¨ä¸­éšå¢åŠ ï¼šå¯¦æˆ°é …ç›®"
  ],
  "needsFix": true
}

score: 0-100åˆ†çš„è©•åˆ†
hasIssues: æ˜¯å¦æœ‰å•é¡Œï¼ˆtrue/falseï¼‰
issues: ç™¼ç¾çš„å•é¡Œåˆ—è¡¨ï¼ˆé™£åˆ—ï¼‰
suggestions: æ”¹é€²å»ºè­°åˆ—è¡¨ï¼ˆé™£åˆ—ï¼‰
needsFix: æ˜¯å¦éœ€è¦ä¿®æ­£ï¼ˆtrue/falseï¼‰

é‡è¦ï¼šåªè¼¸å‡º JSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—æˆ–èªªæ˜ã€‚`;

            try {
                const response = await callAPI(systemPrompt, userPrompt);
                console.log('ğŸ“¥ å“è³ªæª¢æŸ¥åŸå§‹å›æ‡‰:', response);
                
                // æ¸…ç†ä¸¦è§£æ JSON
                let cleaned = response.trim();
                cleaned = cleaned.replace(/```json/g, '').replace(/```/g, '');
                const start = cleaned.indexOf('{');
                const end = cleaned.lastIndexOf('}') + 1;
                
                if (start === -1 || end === 0) {
                    throw new Error('ç„¡æ³•æ‰¾åˆ° JSON æ ¼å¼');
                }
                
                const jsonStr = cleaned.substring(start, end);
                console.log('ğŸ” æå–çš„ JSON:', jsonStr);
                
                qualityCheckResult = JSON.parse(jsonStr);
                console.log('âœ… å“è³ªæª¢æŸ¥å®Œæˆ:', qualityCheckResult);
                
                // é¡¯ç¤ºæª¢æŸ¥çµæœ
                displayQualityCheck(qualityCheckResult);

            } catch (error) {
                console.error('âŒ å“è³ªæª¢æŸ¥å¤±æ•—:', error);
                checkContent.innerHTML = `
                    âš ï¸ å“è³ªæª¢æŸ¥å¤±æ•—ï¼š${error.message}<br>
                    <span style="font-size: 12px;">å­¸ç¿’åœ°åœ–å·²ç”Ÿæˆï¼Œä½ ä»å¯ç¹¼çºŒä½¿ç”¨</span>
                `;
            }
        }

        // ========== é¡¯ç¤ºå“è³ªæª¢æŸ¥çµæœ ==========
        function displayQualityCheck(result) {
            const checkContent = document.getElementById('qualityCheckContent');
            const fixBtn = document.getElementById('btnAutoFix');
            
            let html = '';
            
            // è©•åˆ†
            const scoreColor = result.score >= 80 ? '#28a745' : result.score >= 60 ? '#ffc107' : '#dc3545';
            html += `<div style="font-size: 28px; font-weight: bold; color: ${scoreColor}; margin-bottom: 15px;">
                è©•åˆ†ï¼š${result.score} åˆ†
            </div>`;
            
            // å•é¡Œåˆ—è¡¨
            if (result.hasIssues && result.issues && result.issues.length > 0) {
                html += '<div style="margin-top: 15px; background: white; padding: 15px; border-radius: 8px;">';
                html += '<strong style="font-size: 16px;">ğŸ” ç™¼ç¾çš„å•é¡Œï¼š</strong>';
                html += '<ul style="margin: 10px 0 0 20px; line-height: 1.8;">';
                result.issues.forEach(issue => {
                    html += `<li style="margin: 5px 0;">${issue}</li>`;
                });
                html += '</ul></div>';
            } else {
                html += '<div style="margin-top: 15px; background: #d4edda; padding: 15px; border-radius: 8px; color: #155724;">';
                html += 'âœ… æœªç™¼ç¾æ˜é¡¯å•é¡Œ';
                html += '</div>';
            }
            
            // å»ºè­°
            if (result.suggestions && result.suggestions.length > 0) {
                html += '<div style="margin-top: 15px; background: white; padding: 15px; border-radius: 8px;">';
                html += '<strong style="font-size: 16px;">ğŸ’¡ æ”¹é€²å»ºè­°ï¼š</strong>';
                html += '<ul style="margin: 10px 0 0 20px; line-height: 1.8;">';
                result.suggestions.forEach(suggestion => {
                    html += `<li style="margin: 5px 0;">${suggestion}</li>`;
                });
                html += '</ul></div>';
            }
            
            // çµè«–
            if (result.needsFix) {
                html += '<div style="margin-top: 15px; padding: 15px; background: #fff; border-radius: 8px; border: 2px solid #ff9800;">';
                html += '<strong style="color: #e65100; font-size: 16px;">âš ï¸ å»ºè­°ä½¿ç”¨è‡ªå‹•ä¿®æ­£åŠŸèƒ½ä¾†æ”¹å–„å­¸ç¿’åœ°åœ–å“è³ª</strong>';
                html += '</div>';
                fixBtn.style.display = 'block'; // é¡¯ç¤ºä¿®æ­£æŒ‰éˆ•
                console.log('ğŸ”§ é¡¯ç¤ºè‡ªå‹•ä¿®æ­£æŒ‰éˆ•');
            } else {
                html += '<div style="margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 8px; border: 2px solid #28a745;">';
                html += '<strong style="color: #155724; font-size: 16px;">âœ… å­¸ç¿’åœ°åœ–å“è³ªè‰¯å¥½ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼</strong>';
                html += '</div>';
                fixBtn.style.display = 'none'; // éš±è—ä¿®æ­£æŒ‰éˆ•
            }
            
            checkContent.innerHTML = html;
        }

        // ========== 5. è‡ªå‹•ä¿®æ­£å­¸ç¿’åœ°åœ– ==========
        async function autoFixMap() {
            if (!qualityCheckResult || !currentTopic) {
                alert('è«‹å…ˆç”Ÿæˆå­¸ç¿’åœ°åœ–ï¼');
                return;
            }

            console.log('ğŸ”§ é–‹å§‹è‡ªå‹•ä¿®æ­£...');
            
            // é¡¯ç¤ºä¿®æ­£ä¸­
            const checkContent = document.getElementById('qualityCheckContent');
            const fixBtn = document.getElementById('btnAutoFix');
            
            checkContent.innerHTML = 'â³ AI æ­£åœ¨ä¿®æ­£å­¸ç¿’åœ°åœ–ï¼Œè«‹ç¨å€™...<br><span style="font-size: 14px;">é€™å¯èƒ½éœ€è¦ 10-20 ç§’</span>';
            fixBtn.style.display = 'none';
            
            showLoading('introContent');
            document.getElementById('nodeRadioGroup').innerHTML = '<div class="loading"><div class="spinner"></div>é‡æ–°ç”Ÿæˆä¸­...</div>';

            const systemPrompt = `ä½ æ˜¯ä¸€å€‹å­¸ç¿’è·¯ç·šè¦åŠƒå°ˆå®¶ã€‚è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚
ä½ å¿…é ˆæ ¹æ“šå“è³ªæª¢æŸ¥çš„å»ºè­°ï¼Œé‡æ–°ç”Ÿæˆä¸€å€‹æ›´å¥½çš„å­¸ç¿’åœ°åœ–ã€‚
ä½ å¿…é ˆåªè¼¸å‡ºåˆæ³•çš„ JSON æ ¼å¼,ä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€‚`;

            const userPrompt = `è«‹é‡å°ä¸»é¡Œã€Œ${currentTopic}ã€é‡æ–°ç”Ÿæˆå­¸ç¿’åœ°åœ–ã€‚

ä¹‹å‰çš„å­¸ç¿’åœ°åœ–å­˜åœ¨ä»¥ä¸‹å•é¡Œï¼š
${qualityCheckResult.issues.join('\n')}

æ”¹é€²å»ºè­°ï¼š
${qualityCheckResult.suggestions.join('\n')}

è«‹æ ¹æ“šé€™äº›å»ºè­°ï¼Œç”Ÿæˆä¸€å€‹æ”¹é€²å¾Œçš„å­¸ç¿’åœ°åœ–ï¼Œè¼¸å‡º JSON æ ¼å¼ï¼š
{
  "intro": "ä¸»é¡Œç°¡ä»‹ï¼ˆ100å­—å…§ï¼‰",
  "map": [
    {"title": "æŠ€èƒ½1", "level": "åˆéš", "summary": "æ‘˜è¦"},
    {"title": "æŠ€èƒ½2", "level": "åˆéš", "summary": "æ‘˜è¦"},
    {"title": "æŠ€èƒ½3", "level": "ä¸­éš", "summary": "æ‘˜è¦"},
    {"title": "æŠ€èƒ½4", "level": "ä¸­éš", "summary": "æ‘˜è¦"},
    {"title": "æŠ€èƒ½5", "level": "é€²éš", "summary": "æ‘˜è¦"},
    {"title": "æŠ€èƒ½6", "level": "é€²éš", "summary": "æ‘˜è¦"}
  ]
}

é‡è¦è¦æ±‚ï¼š
1. ç¢ºä¿åˆéšã€ä¸­éšã€é€²éšå„è‡³å°‘æœ‰ 2-3 å€‹ç¯€é»
2. ç¯€é»é †åºè¦ç¬¦åˆå­¸ç¿’é‚è¼¯
3. é¿å…å…§å®¹é‡è¤‡
4. æ¨™é¡Œè¦æ¸…æ™°æ˜ç¢º
5. åªè¼¸å‡º JSONï¼Œä¸è¦æœ‰å…¶ä»–å…§å®¹`;

            try {
                const response = await callAPI(systemPrompt, userPrompt);
                
                // æ¸…ç†ä¸¦è§£æ JSON
                let cleaned = response.trim();
                cleaned = cleaned.replace(/```json/g, '').replace(/```/g, '');
                const start = cleaned.indexOf('{');
                const end = cleaned.lastIndexOf('}') + 1;
                const jsonStr = cleaned.substring(start, end);
                
                const newData = JSON.parse(jsonStr);
                console.log('âœ… ä¿®æ­£å¾Œçš„å­¸ç¿’åœ°åœ–:', newData);

                // æ›´æ–°é¡¯ç¤º
                document.getElementById('introContent').innerHTML = `<h3>ğŸ“˜ ${currentTopic}</h3><p>${newData.intro}</p>`;
                currentMapData = newData.map;
                renderNodeRadios(newData.map);
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                const checkBox = document.getElementById('qualityCheckBox');
                checkContent.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 2px solid #28a745;">
                        <strong style="color: #155724; font-size: 16px;">âœ… å­¸ç¿’åœ°åœ–å·²è‡ªå‹•ä¿®æ­£å®Œæˆï¼</strong>
                        <p style="margin-top: 10px; color: #155724;">æ­£åœ¨é‡æ–°é€²è¡Œå“è³ªæª¢æŸ¥...</p>
                    </div>
                `;
                
                // é‡æ–°æª¢æŸ¥å“è³ª
                setTimeout(() => {
                    checkMapQuality(currentTopic, newData);
                }, 1000);
                
                console.log('ğŸ‰ å­¸ç¿’åœ°åœ–ä¿®æ­£å®Œæˆï¼');

            } catch (error) {
                console.error('âŒ è‡ªå‹•ä¿®æ­£å¤±æ•—:', error);
                checkContent.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 2px solid #dc3545;">
                        <strong style="color: #721c24;">âš ï¸ è‡ªå‹•ä¿®æ­£å¤±æ•—ï¼š${error.message}</strong>
                        <p style="margin-top: 10px; color: #721c24;">è«‹ä½¿ç”¨åŸå§‹å­¸ç¿’åœ°åœ–æˆ–é‡æ–°ç”Ÿæˆ</p>
                    </div>
                `;
                fixBtn.style.display = 'block';
                
                // æ¢å¾©åŸå§‹åœ°åœ–é¡¯ç¤º
                renderNodeRadios(currentMapData);
            }
        }
    </script>
</body>
</html>
